(function(t){var a=PhpDebugBar.utils.makecsscls("phpdebugbar-widgets-"),c=PhpDebugBar.Widgets.SQLQueriesWidget=PhpDebugBar.Widget.extend({className:a("sqlqueries"),onFilterClick:function(l){t(l).toggleClass(a("excluded"));var i=[];this.$toolbar.find(a(".filter")+a(".excluded")).each(function(){i.push(this.rel)}),this.$list.$el.find("li[connection="+t(l).attr("rel")+"]").toggle(),this.set("exclude",i)},onCopyToClipboard:function(l){var i=t(l).parent("li").find("code").get(0),n=function(){try{document.execCommand("copy"),alert("Query copied to the clipboard")}catch{console.log("Oops, unable to copy")}},e=function(d){if(document.selection){var s=document.body.createTextRange();s.moveToElementText(d),s.select()}else if(window.getSelection){var s=document.createRange();s.selectNodeContents(d),window.getSelection().removeAllRanges(),window.getSelection().addRange(s)}n(),window.getSelection().removeAllRanges()};e(i)},renderList:function(l,i,n){var e=t("<ul />").addClass(a("table-list")),d,s=t("<li />").addClass(a("table-list-item")),o=t("<span />").addClass("phpdebugbar-text-muted");for(var p in n){var r=typeof n[p]=="function"?n[p].name+" {}":n[p];s.clone().append(typeof r=="object"&&r!==null?[o.clone().text(r.index||p).append("."),"&nbsp;"].concat(r.namespace?[r.namespace+"::"]:[]).concat([r.name||r.file]).concat(r.line?[o.clone().text(":"+r.line)]:[]):[o.clone().text(p+":"),"&nbsp;",r]).appendTo(e)}return l+=i?' <i class="phpdebugbar-fa phpdebugbar-fa-'+i+' phpdebugbar-text-muted"></i>':"",t("<tr />").append(t("<td />").addClass(a("name")).html(l),t("<td />").addClass(a("value")).append(e))},render:function(){this.$status=t("<div />").addClass(a("status")).appendTo(this.$el),this.$toolbar=t("<div />").addClass(a("toolbar")).appendTo(this.$el);var l=[],i=this;this.$list=new PhpDebugBar.Widgets.ListWidget({itemRenderer:function(n,e){if(e.type==="transaction"?t("<strong />").addClass(a("sql")).addClass(a("name")).text(e.sql).appendTo(n):t("<code />").addClass(a("sql")).html(PhpDebugBar.Widgets.highlight(e.sql,"sql")).appendTo(n),e.width_percent&&t("<div />").addClass(a("bg-measure")).append(t("<div />").addClass(a("value")).css({left:e.start_percent+"%",width:Math.max(e.width_percent,.01)+"%"})).appendTo(n),e.duration_str&&t('<span title="Duration" />').addClass(a("duration")).text(e.duration_str).appendTo(n),e.memory_str&&t('<span title="Memory usage" />').addClass(a("memory")).text(e.memory_str).appendTo(n),typeof e.row_count<"u"&&t('<span title="Row count" />').addClass(a("row-count")).text(e.row_count).appendTo(n),typeof e.stmt_id<"u"&&e.stmt_id&&t('<span title="Prepared statement ID" />').addClass(a("stmt-id")).text(e.stmt_id).appendTo(n),e.connection&&(t('<span title="Connection" />').addClass(a("database")).text(e.connection).appendTo(n),n.attr("connection",e.connection),t.inArray(e.connection,l)==-1&&(l.push(e.connection),t("<a />").addClass(a("filter")).text(e.connection).attr("rel",e.connection).on("click",function(){i.onFilterClick(this)}).appendTo(i.$toolbar),l.length>1&&(i.$toolbar.show(),i.$list.$el.css("margin-bottom","20px")))),typeof e.is_success<"u"&&!e.is_success&&(n.addClass(a("error")),n.append(t("<span />").addClass(a("error")).text("["+e.error_code+"] "+e.error_message))),(!e.type||e.type==="query")&&e.show_copy!==!1&&t('<span title="Copy to clipboard" />').addClass(a("copy-clipboard")).css("cursor","pointer").on("click",function(o){i.onCopyToClipboard(this),o.stopPropagation()}).appendTo(n),typeof e.xdebug_link<"u"&&e.xdebug_link){var d=t('<span title="Filename" />').addClass(a("filename")).text(e.xdebug_link.filename+(e.xdebug_link.line?"#"+e.xdebug_link.line:""));e.xdebug_link.ajax?t('<a title="'+e.xdebug_link.url+'"></a>').on("click",function(){t.ajax(e.xdebug_link.url)}).addClass(a("editor-link")).appendTo(d):t('<a href="'+e.xdebug_link.url+'"></a>').addClass(a("editor-link")).appendTo(d),d.appendTo(n)}var s=t("<table></table>").addClass(a("params"));e.params&&!t.isEmptyObject(e.params)&&i.renderList("Params","thumb-tack",e.params).appendTo(s),e.bindings&&!t.isEmptyObject(e.bindings)&&i.renderList("Bindings","thumb-tack",e.bindings).appendTo(s),e.hints&&!t.isEmptyObject(e.hints)&&i.renderList("Hints","question-circle",e.hints).appendTo(s),e.backtrace&&!t.isEmptyObject(e.backtrace)&&i.renderList("Backtrace","list-ul",e.backtrace).appendTo(s),s.find("tr").length&&(s.appendTo(n),n.css("cursor","pointer").click(function(){if(window.getSelection().type=="Range")return"";s.is(":visible")?s.hide():s.show()}))}}),this.$list.$el.appendTo(this.$el),this.bindAttr("data",function(n){if(n.length<=0||!n.statements)return!1;this.$list.set("data",n.statements),this.$status.empty();for(var e={},d=0,s=0;s<n.statements.length;s++)if(!(n.statements[s].type&&n.statements[s].type!=="query")){var o=n.statements[s].sql;n.statements[s].params&&!t.isEmptyObject(n.statements[s].params)&&(o+=JSON.stringify(n.statements[s].params)),n.statements[s].bindings&&!t.isEmptyObject(n.statements[s].bindings)&&(o+=JSON.stringify(n.statements[s].bindings)),n.statements[s].connection&&(o+="@"+n.statements[s].connection),e[o]=e[o]||{keys:[]},e[o].keys.push(s)}for(var o in e)if(e[o].keys.length>1){d+=e[o].keys.length;for(var s=0;s<e[o].keys.length;s++)this.$list.$el.find("."+a("list-item")).eq(e[o].keys[s]).addClass(a("sql-duplicate"))}var p=t("<span />").text(n.nb_statements+" statements were executed").appendTo(this.$status);if(n.nb_failed_statements&&p.append(", "+n.nb_failed_statements+" of which failed"),d){p.append(", "+d+" of which were duplicates"),p.append(", "+(n.nb_statements-d)+" unique. ");var r="Show only duplicated";t("<a />").addClass(a("duplicates")).click(function(){t(this).toggleClass("shown-duplicated").text(t(this).hasClass("shown-duplicated")?"Show All":r),t("."+i.className+" ."+a("list-item")).not("."+a("sql-duplicate")).toggle()}).text(r).appendTo(p)}n.accumulated_duration_str&&this.$status.append(t('<span title="Accumulated duration" />').addClass(a("duration")).text(n.accumulated_duration_str)),n.memory_usage_str&&this.$status.append(t('<span title="Memory usage" />').addClass(a("memory")).text(n.memory_usage_str))})}})})(PhpDebugBar.$);
