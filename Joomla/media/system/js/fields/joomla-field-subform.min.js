/**
 * @copyright  (C) 2019 Open Source Matters, Inc. <https://www.joomla.org>
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */const KEYCODE={SPACE:"Space",ESC:"Escape",ENTER:"Enter"};function hasModifier(g){return g.ctrlKey||g.metaKey||g.shiftKey}class JoomlaFieldSubform extends HTMLElement{get buttonAdd(){return this.getAttribute("button-add")}get buttonRemove(){return this.getAttribute("button-remove")}get buttonMove(){return this.getAttribute("button-move")}get rowsContainer(){return this.getAttribute("rows-container")}get repeatableElement(){return this.getAttribute("repeatable-element")}get minimum(){return this.getAttribute("minimum")}get maximum(){return this.getAttribute("maximum")}get name(){return this.getAttribute("name")}set name(e){this.template=this.template.replace(new RegExp(` name="${this.name.replace(/[[\]]/g,"\\$&")}`,"g"),` name="${e}`),this.setAttribute("name",e)}constructor(){super();const e=this;if(this.containerWithRows=this,this.rowsContainer){const t=this.querySelectorAll(this.rowsContainer);Array.from(t).forEach(o=>{o.closest("joomla-field-subform")===this&&(this.containerWithRows=o)})}this.lastRowIndex=this.getRows().length-1,this.template="",this.prepareTemplate(),(this.buttonAdd||this.buttonRemove)&&(this.addEventListener("click",t=>{let o=null,l=null;if(e.buttonAdd&&(o=t.target.closest(e.buttonAdd)),e.buttonRemove&&(l=t.target.closest(e.buttonRemove)),o&&o.closest("joomla-field-subform")===e){let n=o.closest(e.repeatableElement);n=n&&n.closest("joomla-field-subform")===e?n:null,e.addRow(n),t.preventDefault()}else if(l&&l.closest("joomla-field-subform")===e){const n=l.closest(e.repeatableElement);e.removeRow(n),t.preventDefault()}}),this.addEventListener("keydown",t=>{if(t.code!==KEYCODE.SPACE)return;const o=e.buttonAdd&&t.target.matches(e.buttonAdd),l=e.buttonRemove&&t.target.matches(e.buttonRemove);if((o||l)&&t.target.closest("joomla-field-subform")===e){let n=t.target.closest(e.repeatableElement);n=n&&n.closest("joomla-field-subform")===e?n:null,l&&n?e.removeRow(n):o&&e.addRow(n),t.preventDefault()}})),this.buttonMove&&this.setUpDragSort()}getRows(){const e=Array.from(this.containerWithRows.children),t=[];return e.forEach(o=>{o.matches(this.repeatableElement)&&t.push(o)}),t}prepareTemplate(){const e=[].slice.call(this.children).filter(t=>t.classList.contains("subform-repeatable-template-section"));if(e[0]&&(this.template=e[0].innerHTML),!this.template)throw new Error("The row template is required for the subform element to work")}addRow(e){const t=this.getRows().length;if(t>=this.maximum)return null;let o;this.containerWithRows.nodeName==="TBODY"||this.containerWithRows.nodeName==="TABLE"?o=document.createElement("tbody"):o=document.createElement("div"),o.innerHTML=this.template;const l=o.children[0];return e?e.parentNode.insertBefore(l,e.nextSibling):this.containerWithRows.append(l),this.buttonMove&&(l.setAttribute("draggable","false"),l.setAttribute("aria-grabbed","false"),l.setAttribute("tabindex","0")),l.setAttribute("data-new","1"),this.fixUniqueAttributes(l,t),this.dispatchEvent(new CustomEvent("subform-row-add",{detail:{row:l},bubbles:!0})),l.dispatchEvent(new CustomEvent("joomla:updated",{bubbles:!0,cancelable:!0})),l}removeRow(e){this.getRows().length<=this.minimum||(this.dispatchEvent(new CustomEvent("subform-row-remove",{detail:{row:e},bubbles:!0})),e.dispatchEvent(new CustomEvent("joomla:removed",{bubbles:!0,cancelable:!0})),e.parentNode.removeChild(e))}fixUniqueAttributes(e,t){const o=t||0,l=e.getAttribute("data-group"),n=e.getAttribute("data-base-name"),p=Math.max(this.lastRowIndex,o),m=n+p;this.lastRowIndex=p+1,e.setAttribute("data-group",m);let r=e.querySelectorAll("[name]");const s={};r=[].slice.call(r).filter(i=>i.nodeName==="JOOMLA-FIELD-SUBFORM"?i.parentElement.closest("joomla-field-subform")===this:i.closest("joomla-field-subform")===this),r.forEach(i=>{const a=i,d=a.getAttribute("name"),A=a.getAttribute("aria-describedby"),u=d.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),R=d.replace(`[${l}][`,`[${m}][`);let b=u.replace(l,m).replace(/\W/g,"_"),c=0,E=u;if(a.type==="checkbox"&&d.match(/\[\]$/)){if(c=s[u]?s[u].length:0,!c){const h=a.closest("fieldset.checkboxes"),f=e.querySelector(`label[for="${u}"]`);h&&h.setAttribute("id",b),f&&(f.setAttribute("for",b),f.setAttribute("id",`${b}-lbl`))}E+=c,b+=c}else if(a.type==="radio"){if(c=s[u]?s[u].length:0,!c){const h=a.closest("fieldset.radio"),f=e.querySelector(`label[for="${u}"]`);h&&h.setAttribute("id",b),f&&(f.setAttribute("for",b),f.setAttribute("id",`${b}-lbl`))}E+=c,b+=c}s[u]?s[u].push(!0):s[u]=[!0],a.name=R,a.id&&(a.id=b),A&&a.setAttribute("aria-describedby",`${R}-desc`);const w=e.querySelector(`label[for="${E}"]`);w&&(w.setAttribute("for",b),w.setAttribute("id",`${b}-lbl`))})}setUpDragSort(){const e=this;let t=null,o=!1;this.getRows().forEach(r=>{r.setAttribute("draggable","false"),r.setAttribute("aria-grabbed","false"),r.setAttribute("tabindex","0")});function l(r){return!r.form&&r.matches(e.buttonMove)?r:r.closest(e.buttonMove)}function n(r,s){let i=!1;if(r.parentNode===s.parentNode){for(let a=r;a;a=a.previousSibling)if(a===s){i=!0;break}}i?s.parentNode.insertBefore(r,s):s.parentNode.insertBefore(r,s.nextSibling)}this.addEventListener("touchstart",r=>{o=!0;const s=l(r.target),i=s?s.closest(e.repeatableElement):null;!i||i.closest("joomla-field-subform")!==e||(t?(i!==t&&n(t,i),t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),t=null):(i.setAttribute("draggable","true"),i.setAttribute("aria-grabbed","true"),t=i),r.preventDefault())}),this.addEventListener("mousedown",({target:r})=>{if(o)return;const s=l(r),i=s?s.closest(e.repeatableElement):null;!i||i.closest("joomla-field-subform")!==e||(i.setAttribute("draggable","true"),i.setAttribute("aria-grabbed","true"),t=i)}),this.addEventListener("mouseup",()=>{t&&!o&&(t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),t=null)}),this.addEventListener("keydown",r=>{if(r.code!==KEYCODE.ESC&&r.code!==KEYCODE.SPACE&&r.code!==KEYCODE.ENTER||r.target.form||!r.target.matches(e.repeatableElement))return;const s=r.target;if(!(!s||s.closest("joomla-field-subform")!==e)&&(r.code===KEYCODE.SPACE&&hasModifier(r)&&(s.getAttribute("aria-grabbed")==="true"?(s.setAttribute("draggable","false"),s.setAttribute("aria-grabbed","false"),t=null):(t&&(t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),t=null),s.setAttribute("draggable","true"),s.setAttribute("aria-grabbed","true"),t=s),r.preventDefault()),r.code===KEYCODE.ESC&&t&&(t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),t=null),r.code===KEYCODE.ENTER&&t)){if(t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),s===t){t=null;return}n(t,s),r.preventDefault(),t=null}}),this.addEventListener("dragstart",({dataTransfer:r})=>{t&&(r.effectAllowed="move",r.setData("text",""))}),this.addEventListener("dragover",r=>{t&&r.preventDefault()}),this.addEventListener("dragenter",({target:r})=>{if(!t||r.parentElement.closest("joomla-field-subform")!==e)return;const s=r.closest(e.repeatableElement);!s||s.closest("joomla-field-subform")!==e||n(t,s)}),this.addEventListener("dragend",()=>{t&&(t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),t=null)});const p=`${e.buttonMove}-up`,m=`${e.buttonMove}-down`;this.addEventListener("click",({target:r})=>{if(r.closest("joomla-field-subform")!==this)return;const s=r.closest(p),i=s?null:r.closest(m);if(!s&&!i)return;let a=(s||i).closest(e.repeatableElement);if(a=a&&a.closest("joomla-field-subform")===this?a:null,!a)return;const d=this.getRows(),A=d.indexOf(a);let u=0;s?(u=A-1,u=u<0?d.length-1:u):(u=A+1,u=u>d.length-1?0:u),n(a,d[u])})}}customElements.define("joomla-field-subform",JoomlaFieldSubform);
